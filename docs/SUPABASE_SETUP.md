# Supabase Setup (Local + Production)

## Local development (recommended)

Local Supabase includes Mailpit so auth emails (invites, password resets) are viewable in a browser.

```bash
supabase start
./scripts/supabase-local.sh
npm run dev
```

- Mailpit UI: `http://127.0.0.1:54324`
- `.env.development.local` is generated by `./scripts/supabase-local.sh` from `supabase status`.
- Email confirmations are disabled by default for local development (`supabase/config.toml`).

## Production setup

### 1) Apply database migrations

The app expects the schema in `supabase/migrations/` to exist in your Supabase project. If you created auth users before running migrations, `009_user_profile_backfill.sql` backfills missing `public.users` rows.

**Option A (recommended): Supabase CLI**

```bash
supabase login
supabase link --project-ref <your-project-ref>
supabase db push
```

**Option B: Supabase Dashboard**

- Dashboard → SQL Editor → run each file in `supabase/migrations/` in order (`001_...` → latest).

### 2) Confirm API schema exposure

If you see PostgREST errors like `PGRST205` (“Could not find the table ... in the schema cache”), confirm:

- Supabase Dashboard → Settings → API → **Exposed schemas** includes `public`

### 3) Configure auth emails (if email confirmation is enabled)

If you require email confirmation, you must configure an email provider in the Supabase Dashboard:

- Authentication → Providers → Email
- Configure SMTP (recommended for production deliverability)

If SMTP isn’t configured, confirmations may not be delivered.

## Troubleshooting

### Login “refresh loop” (returns to login after signing in)

This usually means your Supabase project is missing the app schema (most commonly `public.users`) or the user profile row doesn’t exist. Apply migrations, then backfill profiles.

### Force the app to use remote Supabase in development

If you don’t want local Supabase/Docker:

```bash
AV_DESIGNER_SUPABASE_MODE=remote npm run dev
# or:
npm run dev:remote
```

### Confirm an email + backfill a user profile (SQL)

Run in Supabase Dashboard → SQL Editor (service role context).

```sql
-- 1) Mark the auth user as confirmed
update auth.users
set
  email_confirmed_at = now(),
  confirmation_token = '',
  confirmation_sent_at = null,
  updated_at = now()
where lower(email) = lower('you@example.com');

-- 2) Backfill the corresponding public.users row (requires schema/migrations applied)
insert into public.users (id, email, full_name, avatar_url)
select
  u.id,
  u.email,
  coalesce(u.raw_user_meta_data->>'full_name', split_part(u.email, '@', 1)),
  u.raw_user_meta_data->>'avatar_url'
from auth.users u
where lower(u.email) = lower('you@example.com')
on conflict do nothing;
```
